Dim sumos2 As Double
Dim repayedvalue As Double
Dim pvOutstanding As Double
Dim allocPV As Double


'=========================================================
' RANK 1: PRO-RATA (OLD BEHAVIOUR - PV weighted, iterative)
'=========================================================

'We treat Security(order).MarketValue as PV available to allocate
Do While Security(order).MarketValue > 0.000001

    '1) Build the PV base for pro-rata (sum of PV outstanding)
    sumos2 = 0#
    For i = 1 To Count
        fIndex = fac_inrank(i)
        If fIndex <> -1 Then
            If Facility(fIndex).Compoundrate <> 0 Then
                sumos2 = sumos2 + (Facility(fIndex).RemainosFV / Facility(fIndex).Compoundrate)
            Else
                sumos2 = sumos2 + Facility(fIndex).RemainosFV
            End If
        End If
    Next i

    If sumos2 <= 0# Then Exit Do

    '2) Allocate PV pro-rata, then convert to FV and deduct both
    repayedvalue = 0#

    For i = 1 To Count
        fIndex = fac_inrank(i)
        If fIndex = -1 Then GoTo NextFacilityR1

        'PV outstanding for this facility (same basis as old model)
        If Facility(fIndex).Compoundrate <> 0 Then
            pvOutstanding = Facility(fIndex).RemainosFV / Facility(fIndex).Compoundrate
        Else
            pvOutstanding = Facility(fIndex).RemainosFV
        End If

        'PV allocation share
        allocPV = Security(order).MarketValue * (pvOutstanding / sumos2)

        'Cap PV allocation so we never allocate more PV than outstanding
        If allocPV > pvOutstanding Then allocPV = pvOutstanding

        'Deduct PV
        Facility(fIndex).RemainosPV = Facility(fIndex).RemainosPV - allocPV

        'Convert PV allocation to FV deduction
        If Facility(fIndex).Compoundrate <> 0 Then
            repayFV = allocPV * Facility(fIndex).Compoundrate
        Else
            repayFV = allocPV
        End If

        'Cap FV deduction
        If repayFV > Facility(fIndex).RemainosFV Then repayFV = Facility(fIndex).RemainosFV

        'Deduct FV
        Facility(fIndex).RemainosFV = Facility(fIndex).RemainosFV - repayFV

        'Track PV used in this iteration
        repayedvalue = repayedvalue + allocPV

NextFacilityR1:
    Next i

    '3) Reduce remaining PV market value (iterative to avoid rounding drift)
    Security(order).MarketValue = Security(order).MarketValue - repayedvalue

Loop
