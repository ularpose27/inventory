Sub CalSharingofPV()

    ' 1. INITIAL CHECKS AND SETUP
    If Not ActiveSheet.Name = "Security Apportionment" Then
        MsgBox "Please open sheet 'Security Apportionment'", vbExclamation
        Exit Sub
    End If

    ' Optimization: Speed up the macro by turning off screen updates and calculations
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual

    ' Preparation for PRINT in ECF Report
    Dim PrintRow As Long
    PrintRow = 2
    Dim wsPrint As Worksheet
    Set wsPrint = ThisWorkbook.Sheets("Hide - ECF Report 1")
    wsPrint.Range("A3:N1048576").ClearContents
    wsPrint.Range("B2, E2, F2, J2, H2, L2, M2").ClearContents

    ' Define counters and limits
    Dim i As Long, j As Long, k As Long
    Dim m As Long, n As Long
    m = CountFacility()
    n = CountSecurity()

    Dim BlankRowUpside As Long
    BlankRowUpside = BlankRow_Upside()

    Dim Height As Long
    If m >= 5 Then
        Height = 11 + m
    Else
        Height = 11 + 5
    End If

    Dim startdate As Date
    startdate = Sheets("Start").Range("B3").Value

    ' Load Original Drawn amounts and IRR
    Dim DrawnOriginal(), irr() As Double
    ReDim DrawnOriginal(1 To m), irr(1 To m) As Double

    For i = 1 To m
        DrawnOriginal(i) = Sheets("Hide - Facility").Range("L" & (1 + i)).Value
        irr(i) = Sheets("Facility").Range("AK" & (7 + i)).Value
    Next i

    ' Sort the security list by Date (Descending/Ascending as per original logic)
    Dim securityWs As Worksheet
    Set securityWs = ThisWorkbook.Sheets("Hide - Security1")

    With securityWs.Sort
        .SortFields.Clear
        .SortFields.Add Key:=securityWs.Range("A1"), Order:=xlDescending
        .SortFields.Add Key:=securityWs.Range("I1"), Order:=xlAscending
        .SetRange securityWs.Range("A:K")
        .Header = xlYes
        .Apply
    End With

    ' 2. START SCENARIO LOOP (Upper, Base, Lower, 2nd Strategy)
    Dim scen As Long
    For scen = 1 To 4

        ' Initialize Facility Info for this scenario
        ReDim Facility(1 To m) As FacilityInfo
        For i = 1 To m
            Facility(i).LoanName = Sheets("Facility").Range("J" & (7 + i)).Value
            Facility(i).Compoundrate = 0
            Facility(i).RemainosPV = DrawnOriginal(i)
            Facility(i).RemainosPVStore = 0
            Facility(i).Rank = 0
            Facility(i).Weight = 0
        Next i

        ' Load Securities for this scenario
        ReDim Security(1 To n) As SecurityInfo
        For i = 1 To n
            Security(i).SecurityName = Sheets("Hide - Security1").Range("B" & (1 + i)).Value
            Security(i).OriginalOrder = i
            Security(i).MarketValue = Sheets("Security Apportionment").Range("K" & (BlankRowUpside + 7 + (i - 1) * Height)).Offset(0, 1 + 3 * (scen - 1)).Value
            Security(i).Paymentdate = Sheets("Security Apportionment").Range("K" & (BlankRowUpside + 2 + (i - 1) * Height)).Offset(0, 1 + 3 * (scen - 1)).Value
        Next i

        ' Sort Securities by Payment Date
        Dim temp As SecurityInfo
        For i = 1 To n - 1
            For j = 1 To n - i
                If Security(j).Paymentdate > Security(j + 1).Paymentdate Then
                    temp = Security(j)
                    Security(j) = Security(j + 1)
                    Security(j + 1) = temp
                End If
            Next j
        Next i

        ' 3. DISTRIBUTION PROCESS (Per Security)
        Dim order As Long, currentrank As Long
        Dim sumosPV() As Double, sumosFV() As Double
        ReDim sumosPV(1 To 3), sumosFV(1 To 3) As Double
        Dim remainingMV As Double, repayFV As Double
        Dim fIndex As Long

        For order = 1 To n
            
            ' Store the PV before this security is applied
            For i = 1 To m: Facility(i).RemainosPVStore = Facility(i).RemainosPV: Next i
            
            ' Reset Rank Totals
            For i = 1 To 3: sumosPV(i) = 0: sumosFV(i) = 0: Next i

            ' Find facilities participating in THIS specific security
            Dim rangeStr As String
            rangeStr = "D" & (BlankRowUpside + 9 + (Security(order).OriginalOrder - 1) * Height) _
                     & ":D" & (BlankRowUpside + 9 + m + (Security(order).OriginalOrder - 1) * Height)

            Dim Cell As Range
            Dim facRowOrder As Long: facRowOrder = 0

            For Each Cell In Range(rangeStr)
                For i = 1 To m
                    If Facility(i).LoanName = Cell.Value And Cell.Offset(0, 2).Value <> "" Then
                        ' Convert current PV to FV at the payment date
                        Facility(i).Compoundrate = (1 + irr(i)) ^ (CDbl(Security(order).Paymentdate - startdate) / 365)
                        Facility(i).RemainosFV = Facility(i).Compoundrate * Facility(i).RemainosPV
                        
                        ' Assign Rank and Table Order
                        Facility(i).Rank = Cell.Offset(0, 2).Value
                        facRowOrder = facRowOrder + 1
                        Facility(i).Weight = facRowOrder

                        ' Add to totals for Pro-Rata checks
                        If Facility(i).Rank >= 1 And Facility(i).Rank <= 3 Then
                            sumosPV(Facility(i).Rank) = sumosPV(Facility(i).Rank) + Facility(i).RemainosPV
                            sumosFV(Facility(i).Rank) = sumosFV(Facility(i).Rank) + Facility(i).RemainosFV
                        End If
                        Exit For
                    End If
                Next i
            Next Cell

            ' 4. APPLY SENIORITY (Rank 1 -> 2 -> 3)
            remainingMV = Security(order).MarketValue

            For currentrank = 1 To 3
                
                ' If no money is left, don't look at lower ranks
                If remainingMV <= 0 Then Exit For
                ' If no facilities are in this rank, skip
                If sumosFV(currentrank) <= 0 Then GoTo NextRank

                ' Get facilities in this rank and sort by row order (Weight)
                Dim idx() As Long, sortCount As Long
                sortCount = 0: ReDim idx(1 To m)
                For i = 1 To m
                    If Facility(i).Rank = currentrank Then
                        sortCount = sortCount + 1: idx(sortCount) = i
                    End If
                Next i

                If sortCount > 1 Then
                    For i = 1 To sortCount - 1
                        For j = i + 1 To sortCount
                            If Facility(idx(j)).Weight < Facility(idx(i)).Weight Then
                                Dim tmpIdx As Long: tmpIdx = idx(i): idx(i) = idx(j): idx(j) = tmpIdx
                            End If
                        Next j
                    Next i
                End If

                ' --- START DISTRIBUTION LOGIC ---
                If currentrank = 1 Then
                    ' RANK 1: PRO-RATA
                    If remainingMV >= sumosFV(currentrank) Then
                        ' Pay Rank 1 off completely
                        For i = 1 To sortCount
                            fIndex = idx(i)
                            remainingMV = remainingMV - Facility(fIndex).RemainosFV
                            Facility(fIndex).RemainosFV = 0
                        Next i
                    Else
                        ' Distribute partially based on Factor
                        Dim factor As Double: factor = remainingMV / sumosFV(currentrank)
                        For i = 1 To sortCount
                            fIndex = idx(i)
                            repayFV = Facility(fIndex).RemainosFV * factor
                            Facility(fIndex).RemainosFV = Facility(fIndex).RemainosFV - repayFV
                        Next i
                        remainingMV = 0
                    End If
                Else
                    ' RANK 2 & 3: WATERFALL (One by one)
                    For i = 1 To sortCount
                        fIndex = idx(i)
                        If remainingMV <= 0 Then Exit For
                        repayFV = Facility(fIndex).RemainosFV
                        If repayFV > remainingMV Then repayFV = remainingMV
                        
                        Facility(fIndex).RemainosFV = Facility(fIndex).RemainosFV - repayFV
                        remainingMV = remainingMV - repayFV
                    Next i
                End If

NextRank:
            Next currentrank

            ' Convert back to PV for next iteration and update sheet
            For i = 1 To m
                If Facility(i).Compoundrate <> 0 Then
                    Facility(i).RemainosPV = Facility(i).RemainosFV / Facility(i).Compoundrate
                End If
            Next i

            ' 5. PRINT RESULTS
            For Each Cell In ThisWorkbook.Worksheets("Security Apportionment").Range(rangeStr)
                For i = 1 To m
                    If Facility(i).LoanName = Cell.Value Then
                        If Cell.Offset(0, 2).Value = "" Then
                            Cell.Offset(0, 8 + 2 + 3 * (scen - 1)).Value = 0
                            Cell.Offset(0, 8 + 3 + 3 * (scen - 1)).Value = 0
                        Else
                            ' Paydown PV
                            Cell.Offset(0, 8 + 3 + 3 * (scen - 1)).Value = Facility(i).RemainosPVStore - Facility(i).RemainosPV
                            ' Discount Factor
                            If Facility(i).Compoundrate <> 0 Then
                                Cell.Offset(0, 8 + 1 + 3 * (scen - 1)).Value = 1 / Facility(i).Compoundrate
                            Else
                                Cell.Offset(0, 8 + 1 + 3 * (scen - 1)).Value = 0
                            End If
                            ' Paydown FV
                            Cell.Offset(0, 8 + 2 + 3 * (scen - 1)).Value = (Facility(i).RemainosPVStore - Facility(i).RemainosPV) * Facility(i).Compoundrate
                            
                            ' Log to ECF Report
                            wsPrint.Range("B" & PrintRow).Value = Facility(i).LoanName
                            wsPrint.Range("L" & PrintRow).Value = Facility(i).RemainosPVStore - Facility(i).RemainosPV
                            wsPrint.Range("J" & PrintRow).Value = IIf(Facility(i).Compoundrate <> 0, 1 / Facility(i).Compoundrate, 0)
                            wsPrint.Range("F" & PrintRow).Value = (Facility(i).RemainosPVStore - Facility(i).RemainosPV) * Facility(i).Compoundrate
                            wsPrint.Range("H" & PrintRow).Value = Security(order).Paymentdate
                            wsPrint.Range("M" & PrintRow).Value = Security(order).SecurityName
                            wsPrint.Range("E" & PrintRow).Value = Choose(scen, "Upper", "Base", "Lower", "2nd Strategy")
                            PrintRow = PrintRow + 1
                        End If
                        Exit For
                    End If
                Next i
            Next Cell

            ' Reset rank/weights for the next security
            For i = 1 To m
                Facility(i).Compoundrate = 0: Facility(i).Rank = 0: Facility(i).Weight = 0
            Next i

        Next order
    Next scen

    ' AutoFill formulas in ECF Report
    If PrintRow > 2 Then
        Dim cols As Variant: cols = Array("A", "C", "D", "G", "I", "K", "N")
        For Each v In cols
            wsPrint.Range(v & "2").AutoFill Destination:=wsPrint.Range(v & "2:" & v & (PrintRow - 1)), Type:=xlFillDefault
        Next v
    End If

    ' Re-sort Security list to original
    With securityWs.Sort
        .SortFields.Clear
        .SortFields.Add Key:=securityWs.Range("J1"), Order:=xlAscending
        .SetRange securityWs.Range("A:K")
        .Header = xlYes
        .Apply
    End With

    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True
    MsgBox "Calculation Complete", vbInformation

End Sub
