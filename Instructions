If currentrank = 1 Then
    'RANK 1: PRO-RATA (PV-based, keeps PV/FV consistent)

    Dim totalPV As Double
    Dim factor As Double
    Dim sharePV As Double

    'Use total PV for rank 1 weighting
    totalPV = sumosPV(currentrank)

    If totalPV > 0 Then
        factor = Security(order).MarketValue / totalPV
    Else
        factor = 0
    End If

    remainingMV = Security(order).MarketValue

    For i = 1 To Count

        fIndex = fac_inrank(i)
        If fIndex = -1 Then GoTo NextFacilityR1

        'PV share allocated to this facility
        sharePV = Facility(fIndex).RemainosPV * factor

        'Cap by facility PV and remaining MV
        If sharePV > Facility(fIndex).RemainosPV Then sharePV = Facility(fIndex).RemainosPV
        If sharePV > remainingMV Then sharePV = remainingMV
        If sharePV < 0 Then sharePV = 0

        'Convert PV share to FV reduction
        repayFV = sharePV * Facility(fIndex).Compoundrate
        If repayFV > Facility(fIndex).RemainosFV Then repayFV = Facility(fIndex).RemainosFV

        'Update BOTH PV and FV (critical for consistency)
        Facility(fIndex).RemainosPV = Facility(fIndex).RemainosPV - sharePV
        If Facility(fIndex).RemainosPV < 0 Then Facility(fIndex).RemainosPV = 0

        Facility(fIndex).RemainosFV = Facility(fIndex).RemainosFV - repayFV
        If Facility(fIndex).RemainosFV < 0 Then Facility(fIndex).RemainosFV = 0

        remainingMV = remainingMV - sharePV

NextFacilityR1:
    Next i

    'Keep the leftover (if any) instead of forcing to 0
    Security(order).MarketValue = remainingMV

Else
    'RANK 2 & 3: WATERFALL
