'--------------------------------------------------------
' SITUATION 2 â€“ WATERFALL ALLOCATION (no pro-rata)
'--------------------------------------------------------
ElseIf Security(order).MarketValue < sumosFV(currentrank) Then

    remainingMV = Security(order).MarketValue

    'WATERFALL: facilities ordered by Rank R, then Preference Ranking, then row order
    'fac_inrank() MUST be correctly filled before this loop
    For i = 1 To Count

        fIndex = fac_inrank(i)
        If fIndex = -1 Then GoTo NextFacility

        'Stop when no market value remains
        If remainingMV <= 0 Then Exit For

        'Current FV outstanding for facility
        repayFV = Facility(fIndex).RemainosFV
        If repayFV <= 0 Then GoTo NextFacility

        'Apply waterfall: facility gets MIN(FV, remainingMV)
        If repayFV > remainingMV Then
            repayFV = remainingMV
        End If

        'Reduce facility FV and the remaining MV
        Facility(fIndex).RemainosFV = Facility(fIndex).RemainosFV - repayFV
        remainingMV = remainingMV - repayFV

NextFacility:
    Next i

    'Update remaining security market value
    Security(order).MarketValue = remainingMV

End If
