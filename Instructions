'Build ordered facility list within this rank
'Rule now: order by the row order in the table (Weight), ascending

Dim idx() As Long
Dim sortCount As Long
Dim a As Long, b As Long
Dim tmpIdx As Long

sortCount = 0
ReDim idx(1 To m)

'Collect facilities in this rank
For i = 1 To m
    If Facility(i).Rank = currentrank Then
        sortCount = sortCount + 1
        idx(sortCount) = i
    End If
Next i

If sortCount = 0 Then
    ReDim fac_inrank(1 To m)
    For i = 1 To m
        fac_inrank(i) = -1
    Next i
    Count = 0
Else
    'Sort by Weight (row order)
    If sortCount > 1 Then
        For a = 1 To sortCount - 1
            For b = a + 1 To sortCount
                If Facility(idx(b)).Weight < Facility(idx(a)).Weight Then
                    tmpIdx = idx(a)
                    idx(a) = idx(b)
                    idx(b) = tmpIdx
                End If
            Next b
        Next a
    End If

    ReDim fac_inrank(1 To m)
    For i = 1 To sortCount
        fac_inrank(i) = idx(i)
    Next i
    For i = sortCount + 1 To m
        fac_inrank(i) = -1
    Next i

    Count = sortCount
End If
