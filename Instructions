'no facilities in this rank -> later logic will just skip
If sortCount = 0 Then
    ReDim fac_inrank(1 To m)
    For i = 1 To m
        fac_inrank(i) = -1
    Next i
    Count = 0                         '<<< IMPORTANT
Else
    'sort by preference, then by original order (idx)
    For a = 1 To sortCount - 1
        For b = a + 1 To sortCount
            If pref(b) < pref(a) Or _
               (pref(b) = pref(a) And idx(b) < idx(a)) Then

                tmpPref = pref(a)
                pref(a) = pref(b)
                pref(b) = tmpPref

                tmpIdx = idx(a)
                idx(a) = idx(b)
                idx(b) = tmpIdx
            End If
        Next b
    Next a

    'write sorted list into fac_inrank and pad rest with -1
    ReDim fac_inrank(1 To m)
    For i = 1 To sortCount
        fac_inrank(i) = idx(i)
    Next i
    For i = sortCount + 1 To m
        fac_inrank(i) = -1
    Next i

    Count = sortCount                 '<<< THIS IS WHAT WAS MISSING
End If
