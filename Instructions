If currentrank = 1 Then
    'RANK 1: PRO-RATA (FV/Cash-based so Expected Realization sums match MarketValue)

    Dim totalFV As Double
    Dim factor As Double
    Dim repayPV As Double

    totalFV = sumosFV(currentrank)

    If totalFV > 0 Then
        factor = Security(order).MarketValue / totalFV
    Else
        factor = 0
    End If

    remainingMV = Security(order).MarketValue

    For i = 1 To Count

        fIndex = fac_inrank(i)
        If fIndex = -1 Then GoTo NextFacilityR1

        'Allocate CASH (FV) pro-rata
        repayFV = Facility(fIndex).RemainosFV * factor

        'Cap by remaining facility FV and remaining security MV
        If repayFV > Facility(fIndex).RemainosFV Then repayFV = Facility(fIndex).RemainosFV
        If repayFV > remainingMV Then repayFV = remainingMV
        If repayFV < 0 Then repayFV = 0

        'Reduce facility FV
        Facility(fIndex).RemainosFV = Facility(fIndex).RemainosFV - repayFV
        If Facility(fIndex).RemainosFV < 0 Then Facility(fIndex).RemainosFV = 0

        'Reduce facility PV consistently (PV = FV / Compoundrate)
        If Facility(fIndex).Compoundrate <> 0 Then
            repayPV = repayFV / Facility(fIndex).Compoundrate
        Else
            repayPV = repayFV
        End If

        Facility(fIndex).RemainosPV = Facility(fIndex).RemainosPV - repayPV
        If Facility(fIndex).RemainosPV < 0 Then Facility(fIndex).RemainosPV = 0

        remainingMV = remainingMV - repayFV

NextFacilityR1:
    Next i

    'After pro-rata, leftover should be ~0 (rounding may leave tiny residual)
    If Abs(remainingMV) < 0.000001 Then remainingMV = 0

    Security(order).MarketValue = remainingMV

Else
    'RANK 2 & 3: WATERFALL
