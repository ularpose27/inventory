'=========================================================
' RANK 1: PRO-RATA (OLD MODEL BEHAVIOUR)
' - Security(order).MarketValue is FV available (Expected Realization USD)
' - We allocate FV pro-rata using PV weights (FV/Compoundrate)
'=========================================================

Do While Security(order).MarketValue > 0.1  'same style as old code to avoid rounding drift

    '1) Build PV base used for weighting (sum of PV outstanding)
    sumos2 = 0#
    For i = 1 To Count
        fIndex = fac_inrank(i)
        If fIndex <> -1 Then
            If Facility(fIndex).Compoundrate <> 0 Then
                sumos2 = sumos2 + (Facility(fIndex).RemainosFV / Facility(fIndex).Compoundrate)
            Else
                sumos2 = sumos2 + Facility(fIndex).RemainosFV
            End If
        End If
    Next i

    If sumos2 <= 0# Then Exit Do

    repayedvalue = 0#   'this iterationâ€™s FV allocated

    '2) Allocate FV pro-rata using PV weights
    For i = 1 To Count
        fIndex = fac_inrank(i)
        If fIndex = -1 Then GoTo NextFacilityR1

        'PV outstanding for weighting
        If Facility(fIndex).Compoundrate <> 0 Then
            pvOutstanding = Facility(fIndex).RemainosFV / Facility(fIndex).Compoundrate
        Else
            pvOutstanding = Facility(fIndex).RemainosFV
        End If

        'FV allocation share (IMPORTANT: allocate FV, not PV)
        repayFV = Security(order).MarketValue * (pvOutstanding / sumos2)

        'Cap at remaining FV
        If repayFV > Facility(fIndex).RemainosFV Then repayFV = Facility(fIndex).RemainosFV

        'Deduct FV from debt
        Facility(fIndex).RemainosFV = Facility(fIndex).RemainosFV - repayFV

        'Track FV used
        repayedvalue = repayedvalue + repayFV

        'If facility fully repaid, remove from next loop base (matches old behaviour)
        If Facility(fIndex).RemainosFV <= 0.000001 Then
            Facility(fIndex).RemainosFV = 0#
            fac_inrank(i) = -1
        End If

NextFacilityR1:
    Next i

    '3) Reduce remaining FV market value
    Security(order).MarketValue = Security(order).MarketValue - repayedvalue

Loop
